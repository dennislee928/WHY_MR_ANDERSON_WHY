# Pandora Box Console IDS-IPS - æ ¹ç›®éŒ„ Makefile
# 
# ç”¨é€”ï¼šæ•´é«”å°ˆæ¡ˆç®¡ç†ã€Docker æ“ä½œã€éƒ¨ç½²ç®¡ç†
# 
# æ³¨æ„ï¼š
# - æ­¤ Makefile ç”¨æ–¼æ•´é«”å°ˆæ¡ˆç®¡ç†
# - å¦‚éœ€ç·¨è­¯ Go ç¨‹å¼ï¼Œè«‹ä½¿ç”¨: cd Application/be && make all
# - å¦‚éœ€é–‹ç™¼å‰ç«¯ï¼Œè«‹ä½¿ç”¨: cd Application/Fe && npm run dev

# è®Šæ•¸å®šç¾©
GO_VERSION := 1.24
PROJECT_NAME := pandora-box-console-ids-ips
DOCKER_REGISTRY := your-registry.com
VERSION := $(shell git describe --tags --always --dirty)
BUILD_TIME := $(shell date -u +"%Y-%m-%dT%H:%M:%SZ")
GIT_COMMIT := $(shell git rev-parse HEAD)

# Go ç·¨è­¯åƒæ•¸
LDFLAGS := -ldflags "-X main.Version=$(VERSION) -X main.BuildTime=$(BUILD_TIME) -X main.GitCommit=$(GIT_COMMIT)"
GOFLAGS := -v

# Docker ç›¸é—œ
DOCKER_COMPOSE_FILE := deployments/docker-compose/docker-compose.yml
DOCKER_COMPOSE_TEST_FILE := deployments/docker-compose/docker-compose.test.yml

.PHONY: help build clean test docker-build docker-push deploy

# é è¨­ç›®æ¨™
help: ## é¡¯ç¤ºå¹«åŠ©è¨Šæ¯
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  Pandora Box Console IDS-IPS - æ ¹ç›®éŒ„ Makefile            â•‘"
	@echo "â•‘  ç”¨é€”ï¼šæ•´é«”å°ˆæ¡ˆç®¡ç†ã€Dockerã€éƒ¨ç½²                          â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“ æ³¨æ„ï¼š"
	@echo "  â€¢ ç·¨è­¯ Go ç¨‹å¼: cd Application/be && make all"
	@echo "  â€¢ é–‹ç™¼å‰ç«¯:    cd Application/Fe && npm run dev"
	@echo "  â€¢ æœ¬åœ°æ§‹å»º:    cd Application && ./build-local.*"
	@echo ""
	@echo "ğŸ”§ å¯ç”¨çš„å‘½ä»¤ï¼š"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# å»ºç½®ç›¸é—œï¼ˆå»ºè­°ä½¿ç”¨ Application/be/Makefileï¼‰
build: ## å»ºç½®æ‰€æœ‰åŸ·è¡Œæª”ï¼ˆå»ºè­°ï¼šcd Application/be && make allï¼‰
	@echo "âš ï¸  å»ºè­°ä½¿ç”¨: cd Application/be && make all"
	@echo "ä½¿ç”¨æ ¹ç›®éŒ„ Makefile æ§‹å»º..."
	@cd Application/be && make all

build-app: ## ä½¿ç”¨ Application æ§‹å»ºè…³æœ¬
	@echo "ä½¿ç”¨ Application/build-local è…³æœ¬..."
	@cd Application && ./build-local.sh || .\build-local.ps1

# æ¸…ç†ç›¸é—œ
clean: ## æ¸…ç†å»ºç½®æª”æ¡ˆ
	@echo "Cleaning build artifacts..."
	@rm -rf bin/
	@rm -rf dist/
	@go clean -cache
	@go clean -testcache

# æ¸¬è©¦ç›¸é—œ
test: ## åŸ·è¡Œå–®å…ƒæ¸¬è©¦
	@echo "Running unit tests..."
	@go test -v ./...

test-coverage: ## åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š
	@echo "Running tests with coverage..."
	@go test -v -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html

test-integration: ## åŸ·è¡Œæ•´åˆæ¸¬è©¦
	@echo "Running integration tests..."
	@go test -v -tags=integration ./...

test-benchmark: ## åŸ·è¡Œæ•ˆèƒ½æ¸¬è©¦
	@echo "Running benchmark tests..."
	@go test -bench=. -benchmem ./...

# Docker ç›¸é—œ
docker-build: ## å»ºç½® Docker æ˜ åƒ
	@echo "Building Docker images..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) build

docker-build-no-cache: ## é‡æ–°å»ºç½® Docker æ˜ åƒ (ç„¡å¿«å–)
	@echo "Building Docker images without cache..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) build --no-cache

docker-push: ## æ¨é€ Docker æ˜ åƒåˆ°è¨»å†Šè¡¨
	@echo "Pushing Docker images..."
	@docker tag pandora-agent:latest $(DOCKER_REGISTRY)/pandora-agent:$(VERSION)
	@docker tag axiom-ui:latest $(DOCKER_REGISTRY)/axiom-ui:$(VERSION)
	@docker push $(DOCKER_REGISTRY)/pandora-agent:$(VERSION)
	@docker push $(DOCKER_REGISTRY)/axiom-ui:$(VERSION)

# éƒ¨ç½²ç›¸é—œ
deploy: ## éƒ¨ç½²æœå‹™
	@echo "Deploying services..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) up -d

deploy-dev: ## éƒ¨ç½²é–‹ç™¼ç’°å¢ƒ
	@echo "Deploying development environment..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) -f docker-compose.dev.yml up -d

stop: ## åœæ­¢æœå‹™
	@echo "Stopping services..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) down

restart: ## é‡å•Ÿæœå‹™
	@echo "Restarting services..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) restart

logs: ## æª¢è¦–æœå‹™æ—¥èªŒ
	@docker-compose -f $(DOCKER_COMPOSE_FILE) logs -f

# é–‹ç™¼ç›¸é—œ
dev-setup: ## è¨­ç½®é–‹ç™¼ç’°å¢ƒ
	@echo "Setting up development environment..."
	@go mod download
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@go install github.com/swaggo/swag/cmd/swag@latest
	@cp env.example .env

lint: ## åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥
	@echo "Running linter..."
	@golangci-lint run

fmt: ## æ ¼å¼åŒ–ç¨‹å¼ç¢¼
	@echo "Formatting code..."
	@go fmt ./...
	@goimports -w .

vet: ## åŸ·è¡Œ go vet
	@echo "Running go vet..."
	@go vet ./...

# æ–‡ä»¶ç›¸é—œ
docs: ## ç”¢ç”Ÿ API æ–‡ä»¶
	@echo "Generating API documentation..."
	@swag init -g cmd/ui/main.go -o docs/

docs-serve: ## å•Ÿå‹•æ–‡ä»¶ä¼ºæœå™¨
	@echo "Starting documentation server..."
	@cd docs && python3 -m http.server 8000

# ç›£æ§ç›¸é—œ
metrics: ## æª¢è¦–æŒ‡æ¨™
	@echo "Fetching metrics..."
	@curl -s http://localhost:8080/metrics

health: ## æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹
	@echo "Checking service health..."
	@curl -s http://localhost:8080/health | jq .

status: ## æª¢è¦–æœå‹™ç‹€æ…‹
	@echo "Service status:"
	@docker-compose -f $(DOCKER_COMPOSE_FILE) ps

# è³‡æ–™åº«ç›¸é—œ
db-migrate: ## åŸ·è¡Œè³‡æ–™åº«é·ç§»
	@echo "Running database migrations..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) exec postgres psql -U pandora -d pandora -f /migrations/init.sql

db-backup: ## å‚™ä»½è³‡æ–™åº«
	@echo "Backing up database..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) exec postgres pg_dump -U pandora pandora > backup_$(shell date +%Y%m%d_%H%M%S).sql

db-restore: ## é‚„åŸè³‡æ–™åº« (éœ€è¦æŒ‡å®šæª”æ¡ˆ: make db-restore FILE=backup.sql)
	@echo "Restoring database from $(FILE)..."
	@docker-compose -f $(DOCKER_COMPOSE_FILE) exec -T postgres psql -U pandora -d pandora < $(FILE)

# å®‰å…¨ç›¸é—œ
security-scan: ## åŸ·è¡Œå®‰å…¨æƒæ
	@echo "Running security scan..."
	@go list -json -m all | nancy sleuth

vulnerability-check: ## æª¢æŸ¥å·²çŸ¥æ¼æ´
	@echo "Checking for vulnerabilities..."
	@govulncheck ./...

# æ•ˆèƒ½ç›¸é—œ
profile-cpu: ## ç”¢ç”Ÿ CPU æ•ˆèƒ½åˆ†æ
	@echo "Generating CPU profile..."
	@go tool pprof -http=:8080 http://localhost:8080/debug/pprof/profile

profile-memory: ## ç”¢ç”Ÿè¨˜æ†¶é«”æ•ˆèƒ½åˆ†æ
	@echo "Generating memory profile..."
	@go tool pprof -http=:8080 http://localhost:8080/debug/pprof/heap

# ç‰ˆæœ¬ç›¸é—œ
version: ## é¡¯ç¤ºç‰ˆæœ¬è³‡è¨Š
	@echo "Version: $(VERSION)"
	@echo "Build Time: $(BUILD_TIME)"
	@echo "Git Commit: $(GIT_COMMIT)"

release: ## å»ºç«‹ç™¼å¸ƒç‰ˆæœ¬
	@echo "Creating release $(VERSION)..."
	@git tag -a $(VERSION) -m "Release $(VERSION)"
	@git push origin $(VERSION)

# å·¥å…·ç›¸é—œ
tools: ## å®‰è£é–‹ç™¼å·¥å…·
	@echo "Installing development tools..."
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@go install github.com/swaggo/swag/cmd/swag@latest
	@go install golang.org/x/tools/cmd/goimports@latest
	@go install golang.org/x/vuln/cmd/govulncheck@latest
	@go install github.com/sonatard/noctx/cmd/noctx@latest

# å¿«é€Ÿå•Ÿå‹•
quick-start: dev-setup build deploy ## å¿«é€Ÿå•Ÿå‹• (è¨­ç½®+å»ºç½®+éƒ¨ç½²)

# å®Œæ•´æ¸¬è©¦
full-test: lint vet test test-integration ## åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
