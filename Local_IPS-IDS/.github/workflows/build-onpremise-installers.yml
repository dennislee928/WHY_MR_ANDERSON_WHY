name: Build On-Premise Installers

on:
  push:
    branches:
      - main
      
     
    tags:
      - 'v*'
  pull_request:
    branches:

      - main

  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬è™Ÿï¼ˆä¾‹å¦‚ï¼š1.0.0ï¼‰'
        required: false
        default: 'dev'

env:
  GO_VERSION: '1.21'
  NODE_VERSION: '18'
  PRODUCT_NAME: 'Pandora Box Console IDS-IPS'
  
jobs:
  # æº–å‚™å·¥ä½œï¼šå–å¾—ç‰ˆæœ¬è³‡è¨Šå’Œæ§‹å»ºç’°å¢ƒ
  prepare:
    name: æº–å‚™æ§‹å»ºç’°å¢ƒ
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      git_commit: ${{ steps.version.outputs.git_commit }}
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: å–å¾—ç‰ˆæœ¬è³‡è¨Š
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          if [[ "$EVENT_NAME" == "workflow_dispatch" && -n "$INPUT_VERSION" ]]; then
            VERSION="$INPUT_VERSION"
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            # å˜—è©¦å–å¾—æœ€è¿‘çš„ tagï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨åˆ†æ”¯å + commit hash
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [[ -n "$LATEST_TAG" ]]; then
              # å¦‚æœæœ‰ tagï¼Œä½¿ç”¨ tag + commit count + hash
              TAG_VERSION="${LATEST_TAG#v}"  # ç§»é™¤ v å‰ç¶´
              COMMIT_COUNT=$(git rev-list --count HEAD ^$(git rev-list --max-parents=0 HEAD))
              SHORT_HASH=$(git rev-parse --short HEAD)
              VERSION="${TAG_VERSION}.${COMMIT_COUNT}+${SHORT_HASH}"
            else
              # æ²’æœ‰ tag æ™‚ï¼Œä½¿ç”¨åˆ†æ”¯å + commit hash
              BRANCH_NAME="${{ github.ref_name }}"
              SHORT_HASH=$(git rev-parse --short HEAD)
              VERSION="0.1.0+${BRANCH_NAME}.${SHORT_HASH}"
            fi
          fi
          
          # ç¢ºä¿ç‰ˆæœ¬è™Ÿä»¥æ•¸å­—é–‹é ­
          if [[ ! "$VERSION" =~ ^[0-9] ]]; then
            VERSION="0.1.0+${VERSION}"
          fi
          
          BUILD_DATE=$(date -u '+%Y-%m-%d_%H:%M:%S')
          GIT_COMMIT=$(git rev-parse --short HEAD)
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "git_commit=$GIT_COMMIT" >> $GITHUB_OUTPUT
          
          echo "ç‰ˆæœ¬: $VERSION"
          echo "æ§‹å»ºæ—¥æœŸ: $BUILD_DATE"
          echo "Git Commit: $GIT_COMMIT"

  # æ§‹å»ºå¾Œç«¯ï¼ˆGoï¼‰
  build-backend:
    name: æ§‹å»ºå¾Œç«¯ç¨‹å¼
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        arch: [amd64, arm64]
        exclude:
          - os: windows-latest
            arch: arm64
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­å®š Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum
      
      - name: ä¸‹è¼‰ä¾è³´
        run: |
          go mod download
          go mod verify
      
      - name: è¨­å®šæª”æ¡ˆåç¨±å¾Œç¶´
        id: setup
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            echo "binary_ext=.exe" >> $GITHUB_OUTPUT
          else
            echo "binary_ext=" >> $GITHUB_OUTPUT
          fi
      
      - name: Build backend binaries (Windows)
        if: matrix.os == 'windows-latest'
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          BUILD_DATE: ${{ needs.prepare.outputs.build_date }}
          GIT_COMMIT: ${{ needs.prepare.outputs.git_commit }}
          GOOS: windows
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "dist/backend"
          $LDFLAGS = "-s -w -X main.Version=$env:VERSION -X main.BuildTime=$env:BUILD_DATE -X main.GitCommit=$env:GIT_COMMIT"
          go mod download
          go mod verify
          Write-Host "Building Agent (GOOS=$env:GOOS, GOARCH=$env:GOARCH)..." -ForegroundColor Cyan
          go build -ldflags="$LDFLAGS" -o "dist/backend/pandora-agent.exe" ./cmd/agent/main.go
          if ($LASTEXITCODE -ne 0) { Write-Host "[ERROR] Agent build failed" -ForegroundColor Red; exit 1 }
          Write-Host "Building Console (GOOS=$env:GOOS, GOARCH=$env:GOARCH)..." -ForegroundColor Cyan
          go build -ldflags="$LDFLAGS" -o "dist/backend/pandora-console.exe" ./cmd/console/main.go
          if ($LASTEXITCODE -ne 0) { Write-Host "[ERROR] Console build failed" -ForegroundColor Red; exit 1 }
          Write-Host "Building UI Server (GOOS=$env:GOOS, GOARCH=$env:GOARCH)..." -ForegroundColor Cyan
          go build -ldflags="$LDFLAGS" -o "dist/backend/axiom-ui.exe" ./cmd/ui/main.go
          if ($LASTEXITCODE -ne 0) { Write-Host "[ERROR] UI Server build failed" -ForegroundColor Red; exit 1 }
          Write-Host "[SUCCESS] All backend binaries built successfully" -ForegroundColor Green
      
      - name: Build backend binaries (Linux/Mac)
        if: matrix.os != 'windows-latest'
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          BUILD_DATE: ${{ needs.prepare.outputs.build_date }}
          GIT_COMMIT: ${{ needs.prepare.outputs.git_commit }}
          GOOS: ${{ matrix.os == 'ubuntu-latest' && 'linux' || 'darwin' }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        shell: bash
        run: |
          mkdir -p dist/backend
          LDFLAGS="-s -w -X main.Version=$VERSION -X main.BuildTime=$BUILD_DATE -X main.GitCommit=$GIT_COMMIT"
          go mod download
          go mod verify
          echo "Building Agent (GOOS=$GOOS, GOARCH=$GOARCH)..."
          go build -ldflags="$LDFLAGS" -o "dist/backend/pandora-agent" ./cmd/agent/main.go
          if [ $? -ne 0 ]; then echo "[ERROR] Agent build failed"; exit 1; fi
          echo "Building Console (GOOS=$GOOS, GOARCH=$GOARCH)..."
          go build -ldflags="$LDFLAGS" -o "dist/backend/pandora-console" ./cmd/console/main.go
          if [ $? -ne 0 ]; then echo "[ERROR] Console build failed"; exit 1; fi
          echo "Building UI Server (GOOS=$GOOS, GOARCH=$GOARCH)..."
          go build -ldflags="$LDFLAGS" -o "dist/backend/axiom-ui" ./cmd/ui/main.go
          if [ $? -ne 0 ]; then echo "[ERROR] UI Server build failed"; exit 1; fi
          echo "[SUCCESS] All backend binaries built successfully"
      
      - name: Copy config files (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          Write-Host "Copying configuration files..." -ForegroundColor Cyan
          if (Test-Path "configs") { Copy-Item -Path "configs" -Destination "dist/backend/" -Recurse -Force; Write-Host "[SUCCESS] configs directory copied" -ForegroundColor Green } else { Write-Host "[WARNING] configs directory not found" -ForegroundColor Yellow }
          if (Test-Path "scripts") { Copy-Item -Path "scripts" -Destination "dist/backend/" -Recurse -Force; Write-Host "[SUCCESS] scripts directory copied" -ForegroundColor Green } else { Write-Host "[WARNING] scripts directory not found, skipping" -ForegroundColor Yellow }
          Write-Host "Backend artifacts structure:" -ForegroundColor Cyan
          Get-ChildItem -Path "dist/backend" -Recurse | Format-Table Name, Length, LastWriteTime -AutoSize
      
      - name: Copy config files (Linux/Mac)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          echo "Copying configuration files..."
          if [ -d "configs" ]; then cp -r configs dist/backend/; echo "[SUCCESS] configs directory copied"; else echo "[WARNING] configs directory not found"; fi
          if [ -d "scripts" ]; then cp -r scripts dist/backend/; echo "[SUCCESS] scripts directory copied"; else echo "[WARNING] scripts directory not found, skipping"; fi
          echo "Backend artifacts structure:"
          ls -la dist/backend/
      
      - name: ä¸Šå‚³æ§‹å»ºç”¢ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/backend/
          retention-days: 7

  # æ§‹å»ºå‰ç«¯ï¼ˆNext.jsï¼‰
  build-frontend:
    name: æ§‹å»ºå‰ç«¯æ‡‰ç”¨ç¨‹å¼
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Application/Fe/package.json
      
      - name: æª¢æŸ¥å‰ç«¯ç›®éŒ„
        run: |
          echo "æª¢æŸ¥ Application/Fe ç›®éŒ„çµæ§‹..."
          ls -la Application/Fe/ || echo "Application/Fe ç›®éŒ„ä¸å­˜åœ¨"
          if [ -f "Application/Fe/package.json" ]; then
            echo "[SUCCESS] package.json å­˜åœ¨"
            cat Application/Fe/package.json | head -10
          else
            echo "[ERROR] package.json ä¸å­˜åœ¨"
            exit 1
          fi
      
      - name: æª¢æŸ¥ä¸¦ç”Ÿæˆ package-lock.json
        working-directory: Application/Fe
        run: |
          echo "ç•¶å‰ç›®éŒ„: $(pwd)"
          echo "ç›®éŒ„å…§å®¹:"
          ls -la
          
          if [ ! -f "package-lock.json" ]; then
            echo "[WARNING] package-lock.json ä¸å­˜åœ¨ï¼Œæ­£åœ¨ç”Ÿæˆ..."
            npm install --package-lock-only
            if [ $? -ne 0 ]; then
              echo "[ERROR] ç”Ÿæˆ package-lock.json å¤±æ•—"
              exit 1
            fi
            echo "[SUCCESS] package-lock.json å·²ç”Ÿæˆ"
          else
            echo "[SUCCESS] package-lock.json å·²å­˜åœ¨"
          fi
      
      - name: å®‰è£ä¾è³´
        working-directory: Application/Fe
        run: |
          echo "æ­£åœ¨å®‰è£ä¾è³´..."
          if [ -f "package-lock.json" ]; then
            echo "ä½¿ç”¨ npm ci..."
            npm ci
          else
            echo "ä½¿ç”¨ npm install..."
            npm install
          fi
          
          if [ $? -ne 0 ]; then
            echo "[ERROR] ä¾è³´å®‰è£å¤±æ•—"
            exit 1
          fi
          echo "[SUCCESS] ä¾è³´å®‰è£å®Œæˆ"
      
      - name: æ§‹å»ºå‰ç«¯
        working-directory: Application/Fe
        env:
          NEXT_PUBLIC_APP_VERSION: ${{ needs.prepare.outputs.version }}
          NODE_ENV: production
        run: |
          echo "æ­£åœ¨æ§‹å»ºå‰ç«¯æ‡‰ç”¨ç¨‹å¼..."
          echo "ç’°å¢ƒè®Šæ•¸:"
          echo "  NEXT_PUBLIC_APP_VERSION: $NEXT_PUBLIC_APP_VERSION"
          echo "  NODE_ENV: $NODE_ENV"
          
          npm run build
          if [ $? -ne 0 ]; then
            echo "[ERROR] å‰ç«¯æ§‹å»ºå¤±æ•—"
            exit 1
          fi
          
          echo "[SUCCESS] å‰ç«¯æ§‹å»ºå®Œæˆ"
          echo "æ§‹å»ºç”¢ç‰©:"
          ls -la .next/ || echo "æœªæ‰¾åˆ° .next ç›®éŒ„"
          
          # å‰µå»ºç¨ç«‹éƒ¨ç½²åŒ…
          mkdir -p ../../dist/frontend
          if [ -d ".next/standalone" ]; then
            echo "è¤‡è£½ standalone ç”¢ç‰©..."
            cp -r .next/standalone/* ../../dist/frontend/
          else
            echo "[WARNING] æœªæ‰¾åˆ° .next/standaloneï¼Œå˜—è©¦è¤‡è£½æ•´å€‹ .next ç›®éŒ„"
            cp -r .next ../../dist/frontend/.next/
          fi
          
          if [ -d ".next/static" ]; then
            echo "è¤‡è£½ static è³‡æº..."
            cp -r .next/static ../../dist/frontend/.next/
          fi
          
          if [ -d "public" ]; then
            echo "è¤‡è£½ public è³‡æº..."
            cp -r public ../../dist/frontend/
          fi
          
          echo "[SUCCESS] å‰ç«¯ç”¢ç‰©è¤‡è£½å®Œæˆ"
          ls -la ../../dist/frontend/
      
      - name: ä¸Šå‚³æ§‹å»ºç”¢ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend
          path: dist/frontend/
          retention-days: 7

  # æ§‹å»º Windows å®‰è£æª”ï¼ˆ.exe å’Œ .msiï¼‰
  build-windows-installer:
    name: æ§‹å»º Windows å®‰è£æª”
    needs: [prepare, build-backend, build-frontend]
    runs-on: windows-latest
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: ä¸‹è¼‰å¾Œç«¯æ§‹å»ºç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          name: backend-windows-latest-amd64
          path: installer/backend
      
      - name: ä¸‹è¼‰å‰ç«¯æ§‹å»ºç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          name: frontend
          path: installer/frontend
      
      - name: å®‰è£ Inno Setup
        run: |
          Write-Host "Attempting to install Inno Setup via Chocolatey..." -ForegroundColor Cyan
          try {
            choco install innosetup -y
            if ($LASTEXITCODE -ne 0) { throw "Chocolatey installation failed" }
          } catch {
            Write-Host "Chocolatey failed, trying direct download..." -ForegroundColor Yellow
            $innosetupUrl = "https://files.jrsoftware.org/is/6/innosetup-6.5.4.exe"
            $installerPath = "$env:TEMP\innosetup-installer.exe"
            Invoke-WebRequest -Uri $innosetupUrl -OutFile $installerPath
            Start-Process -FilePath $installerPath -ArgumentList "/SILENT", "/DIR=C:\Program Files (x86)\Inno Setup 6" -Wait
            if ($LASTEXITCODE -ne 0) { Write-Host "[ERROR] Inno Setup installation failed" -ForegroundColor Red; exit 1 }
            Write-Host "[SUCCESS] Inno Setup installed via direct download" -ForegroundColor Green
          }
      
      - name: å‰µå»º Inno Setup è…³æœ¬
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          
          @"
          #define MyAppName "${{ env.PRODUCT_NAME }}"
          #define MyAppVersion "$version"
          #define MyAppPublisher "Pandora Security Team"
          #define MyAppURL "https://github.com/your-org/pandora_box_console_IDS-IPS"
          #define MyAppExeName "pandora-agent.exe"

          [Setup]
          AppId={{PANDORA-BOX-CONSOLE-IDS-IPS}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          AppPublisherURL={#MyAppURL}
          DefaultDirName={autopf}\PandoraBox
          DefaultGroupName={#MyAppName}
          OutputBaseFilename=pandora-box-console-$version-windows-amd64-setup
          OutputDir=dist
          Compression=lzma2
          SolidCompression=yes
          WizardStyle=modern
          PrivilegesRequired=admin
          ArchitecturesAllowed=x64
          ArchitecturesInstallIn64BitMode=x64

          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Tasks]
          Name: "desktopicon"; Description: "Create desktop shortcut"; GroupDescription: "Additional icons:"; Flags: unchecked
          Name: "quicklaunchicon"; Description: "Create quick launch shortcut"; GroupDescription: "Additional icons:"; Flags: unchecked

          [Files]
          Source: "backend\*"; DestDir: "{app}\backend"; Flags: ignoreversion recursesubdirs createallsubdirs
          Source: "frontend\*"; DestDir: "{app}\frontend"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon
          Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: quicklaunchicon

          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent

          [Code]
          function InitializeSetup(): Boolean;
          begin
            Result := True;
            if not IsAdminLoggedOn() then
            begin
              MsgBox('This program requires administrator privileges to install.', mbError, MB_OK);
              Result := False;
            end;
          end;
          "@ | Out-File -FilePath installer\setup.iss -Encoding UTF8
      
      - name: Build Windows installer
        run: |
          New-Item -ItemType Directory -Force -Path "installer\dist" | Out-Null
          New-Item -ItemType Directory -Force -Path "dist" | Out-Null
          Push-Location installer
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss
          Pop-Location
          if (Test-Path "installer\dist\*.exe") { Move-Item -Path "installer\dist\*.exe" -Destination "dist\" -Force }
      
      - name: ä¸Šå‚³ Windows å®‰è£ç¨‹å¼
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: dist/*.exe
          retention-days: 30

  # æ§‹å»º Linux å¥—ä»¶ï¼ˆ.deb å’Œ .rpmï¼‰
  build-linux-packages:
    name: æ§‹å»º Linux å¥—ä»¶
    needs: [prepare, build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: ä¸‹è¼‰å¾Œç«¯æ§‹å»ºç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          name: backend-ubuntu-latest-amd64
          path: package/backend
      
      - name: ä¸‹è¼‰å‰ç«¯æ§‹å»ºç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          name: frontend
          path: package/frontend
      
      - name: å®‰è£æ‰“åŒ…å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev rpm
      
      - name: å‰µå»º DEB å¥—ä»¶çµæ§‹
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          PACKAGE_NAME="pandora-box-console"
          
          mkdir -p debian/DEBIAN
          mkdir -p debian/opt/pandora-box/{backend,frontend,configs}
          mkdir -p debian/etc/systemd/system
          mkdir -p debian/usr/local/bin
          
          # è¤‡è£½æª”æ¡ˆ
          cp -r package/backend/* debian/opt/pandora-box/backend/
          cp -r package/frontend/* debian/opt/pandora-box/frontend/
          
          # è¨­å®šåŸ·è¡Œæ¬Šé™
          chmod +x debian/opt/pandora-box/backend/*
          
          # å‰µå»º systemd æœå‹™æª”æ¡ˆ
          cat > debian/etc/systemd/system/pandora-agent.service <<EOF
          [Unit]
          Description=Pandora Box Console Agent
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/pandora-box/backend
          ExecStart=/opt/pandora-box/backend/pandora-agent --config /opt/pandora-box/backend/configs/agent-config.yaml
          Restart=on-failure
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF
          
          # å‰µå»ºæ§åˆ¶æª”æ¡ˆ
          cat > debian/DEBIAN/control <<EOF
          Package: $PACKAGE_NAME
          Version: $VERSION
          Section: net
          Priority: optional
          Architecture: amd64
          Depends: libc6 (>= 2.31), postgresql-client, redis-tools
          Maintainer: Pandora Security Team <support@pandora-ids.com>
          Description: Pandora Box Console IDS-IPS System
           ä¸€å€‹åŸºæ–¼ USB-SERIAL CH340 çš„æ™ºæ…§å‹å…¥ä¾µåµæ¸¬èˆ‡é˜²è­·ç³»çµ±ã€‚
           æ•´åˆäº†ç¾ä»£åŒ–çš„ç›£æ§ã€æ—¥èªŒèšåˆã€å¨è„…åˆ†æå’Œè¦–è¦ºåŒ–æŠ€è¡“ã€‚
          EOF
          
          # å‰µå»ºå®‰è£å¾Œè…³æœ¬
          cat > debian/DEBIAN/postinst <<'EOF'
          #!/bin/bash
          set -e
          
          echo "æ­£åœ¨é…ç½® Pandora Box Console..."
          
          # é‡æ–°è¼‰å…¥ systemd
          systemctl daemon-reload
          
          # å•Ÿç”¨æœå‹™ï¼ˆä½†ä¸è‡ªå‹•å•Ÿå‹•ï¼‰
          systemctl enable pandora-agent.service
          
          echo "å®‰è£å®Œæˆï¼ä½¿ç”¨ 'systemctl start pandora-agent' å•Ÿå‹•æœå‹™ã€‚"
          EOF
          
          chmod 755 debian/DEBIAN/postinst
          
          # å‰µå»ºè¼¸å‡ºç›®éŒ„
          mkdir -p dist
          
          # æ§‹å»º DEB å¥—ä»¶
          dpkg-deb --build debian dist/${PACKAGE_NAME}_${VERSION}_amd64.deb
      
      - name: å‰µå»º RPM å¥—ä»¶
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          PACKAGE_NAME="pandora-box-console"
          
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          # å‰µå»º spec æª”æ¡ˆ
          cat > ~/rpmbuild/SPECS/${PACKAGE_NAME}.spec <<EOF
          Name:           $PACKAGE_NAME
          Version:        $VERSION
          Release:        1%{?dist}
          Summary:        Pandora Box Console IDS-IPS System
          
          License:        MIT
          URL:            https://github.com/your-org/pandora_box_console_IDS-IPS
          Source0:        %{name}-%{version}.tar.gz
          
          Requires:       glibc >= 2.31, postgresql, redis
          
          %description
          ä¸€å€‹åŸºæ–¼ USB-SERIAL CH340 çš„æ™ºæ…§å‹å…¥ä¾µåµæ¸¬èˆ‡é˜²è­·ç³»çµ±ã€‚
          æ•´åˆäº†ç¾ä»£åŒ–çš„ç›£æ§ã€æ—¥èªŒèšåˆã€å¨è„…åˆ†æå’Œè¦–è¦ºåŒ–æŠ€è¡“ã€‚
          
          %prep
          
          %build
          
          %install
          rm -rf \$RPM_BUILD_ROOT
          mkdir -p \$RPM_BUILD_ROOT/opt/pandora-box/{backend,frontend}
          mkdir -p \$RPM_BUILD_ROOT/etc/systemd/system
          
          cp -r package/backend/* \$RPM_BUILD_ROOT/opt/pandora-box/backend/
          cp -r package/frontend/* \$RPM_BUILD_ROOT/opt/pandora-box/frontend/
          
          cat > \$RPM_BUILD_ROOT/etc/systemd/system/pandora-agent.service <<'SVCEOF'
          [Unit]
          Description=Pandora Box Console Agent
          After=network.target
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/pandora-box/backend
          ExecStart=/opt/pandora-box/backend/pandora-agent --config /opt/pandora-box/backend/configs/agent-config.yaml
          Restart=on-failure
          
          [Install]
          WantedBy=multi-user.target
          SVCEOF
          
          %files
          /opt/pandora-box/*
          /etc/systemd/system/pandora-agent.service
          
          %post
          systemctl daemon-reload
          systemctl enable pandora-agent.service
          
          %changelog
          * $(date "+%a %b %d %Y") Pandora Team <support@pandora-ids.com> - $VERSION-1
          - Initial release
          EOF
          
          # æ§‹å»º RPMï¼ˆç°¡åŒ–ç‰ˆï¼Œå¯¦éš›éœ€è¦å®Œæ•´çš„æ§‹å»ºç’°å¢ƒï¼‰
          # rpmbuild -ba ~/rpmbuild/SPECS/${PACKAGE_NAME}.spec
          
          echo "RPM spec æª”æ¡ˆå·²å‰µå»ºæ–¼ ~/rpmbuild/SPECS/"
      
      - name: ä¸Šå‚³ Linux å¥—ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            dist/*.deb
            ~/rpmbuild/RPMS/**/*.rpm
          retention-days: 30

  # æ§‹å»º OVA è™›æ“¬æ©Ÿæ˜ åƒ
  build-ova-image:
    name: æ§‹å»º OVA è™›æ“¬æ©Ÿæ˜ åƒ
    needs: [prepare, build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: ä¸‹è¼‰å¾Œç«¯æ§‹å»ºç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          name: backend-ubuntu-latest-amd64
          path: vm/backend
      
      - name: ä¸‹è¼‰å‰ç«¯æ§‹å»ºç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          name: frontend
          path: vm/frontend
      
      - name: å®‰è£ Packer
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update
          sudo apt-get install -y packer
      
      - name: å‰µå»º Packer é…ç½®
        run: |
          cat > packer-config.pkr.hcl <<'EOF'
          packer {
            required_plugins {
              virtualbox = {
                version = ">= 1.0.0"
                source  = "github.com/hashicorp/virtualbox"
              }
            }
          }
          
          source "virtualbox-iso" "pandora-box" {
            guest_os_type    = "Ubuntu_64"
            iso_url          = "https://releases.ubuntu.com/22.04/ubuntu-22.04.3-live-server-amd64.iso"
            iso_checksum     = "sha256:a4acfda10b18da50e2ec50ccaf860d7f20b389df8765611142305c0e911d16fd"
            ssh_username     = "pandora"
            ssh_password     = "pandora"
            ssh_timeout      = "20m"
            shutdown_command = "echo 'pandora' | sudo -S shutdown -P now"
            format           = "ova"
            output_directory = "dist"
            vm_name          = "pandora-box-${{ needs.prepare.outputs.version }}"
            
            vboxmanage = [
              ["modifyvm", "{{.Name}}", "--memory", "4096"],
              ["modifyvm", "{{.Name}}", "--cpus", "2"],
              ["modifyvm", "{{.Name}}", "--vram", "128"]
            ]
          }
          
          build {
            sources = ["source.virtualbox-iso.pandora-box"]
            
            provisioner "shell" {
              inline = [
                "sudo apt-get update",
                "sudo apt-get install -y postgresql redis-server nginx",
                "sudo systemctl enable postgresql redis-server nginx"
              ]
            }
            
            provisioner "file" {
              source      = "vm/backend"
              destination = "/tmp/"
            }
            
            provisioner "file" {
              source      = "vm/frontend"
              destination = "/tmp/"
            }
            
            provisioner "shell" {
              inline = [
                "sudo mkdir -p /opt/pandora-box",
                "sudo mv /tmp/backend /opt/pandora-box/",
                "sudo mv /tmp/frontend /opt/pandora-box/",
                "sudo chmod +x /opt/pandora-box/backend/*"
              ]
            }
          }
          EOF
      
      - name: æ§‹å»º OVA æ˜ åƒ
        run: |
          # æ³¨æ„ï¼šåœ¨ GitHub Actions ä¸Šæ§‹å»º OVA éœ€è¦åµŒå¥—è™›æ“¬åŒ–æ”¯æ´
          # é€™è£¡åƒ…å‰µå»ºé…ç½®æª”æ¡ˆï¼Œå¯¦éš›æ§‹å»ºå¯èƒ½éœ€è¦åœ¨æœ¬åœ°æˆ–å°ˆç”¨ CI ç’°å¢ƒé€²è¡Œ
          echo "OVA é…ç½®æª”æ¡ˆå·²å‰µå»º"
          echo "å¯¦éš›æ§‹å»ºéœ€è¦åœ¨æ”¯æ´è™›æ“¬åŒ–çš„ç’°å¢ƒä¸­åŸ·è¡Œï¼špacker build packer-config.pkr.hcl"
      
      - name: ä¸Šå‚³ OVA é…ç½®
        uses: actions/upload-artifact@v4
        with:
          name: ova-config
          path: packer-config.pkr.hcl
          retention-days: 30

  # æ§‹å»º ISO å…‰ç¢Ÿæ˜ åƒ
  build-iso-image:
    name: æ§‹å»º ISO å®‰è£å…‰ç¢Ÿ
    needs: [prepare, build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: ä¸‹è¼‰æ‰€æœ‰æ§‹å»ºç”¢ç‰©
        uses: actions/download-artifact@v4
      
      - name: å®‰è£ ISO æ§‹å»ºå·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y genisoimage syslinux isolinux
      
      - name: å‰µå»º ISO æª”æ¡ˆçµæ§‹
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          ISO_DIR="iso"
          
          mkdir -p $ISO_DIR/{backend,frontend,configs,scripts}
          mkdir -p $ISO_DIR/isolinux
          
          # è¤‡è£½æª”æ¡ˆ
          cp -r backend-ubuntu-latest-amd64/* $ISO_DIR/backend/ || true
          cp -r frontend/* $ISO_DIR/frontend/ || true
          cp -r configs $ISO_DIR/
          
          # å‰µå»ºå®‰è£è…³æœ¬
          cat > $ISO_DIR/install.sh <<'INSTALLEOF'
          #!/bin/bash
          set -e
          
          echo "======================================"
          echo "  Pandora Box Console IDS-IPS å®‰è£ç¨‹å¼  "
          echo "======================================"
          echo ""
          
          # æª¢æŸ¥æ¬Šé™
          if [ "$EUID" -ne 0 ]; then
            echo "è«‹ä½¿ç”¨ root æ¬Šé™åŸ·è¡Œæ­¤è…³æœ¬"
            exit 1
          fi
          
          # å®‰è£ç›®éŒ„
          INSTALL_DIR="/opt/pandora-box"
          
          echo "æ­£åœ¨å®‰è£åˆ° $INSTALL_DIR..."
          
          # å‰µå»ºç›®éŒ„
          mkdir -p $INSTALL_DIR/{backend,frontend,configs,logs}
          
          # è¤‡è£½æª”æ¡ˆ
          cp -r backend/* $INSTALL_DIR/backend/
          cp -r frontend/* $INSTALL_DIR/frontend/
          cp -r configs/* $INSTALL_DIR/configs/
          
          # è¨­å®šæ¬Šé™
          chmod +x $INSTALL_DIR/backend/*
          
          # å®‰è£ systemd æœå‹™
          cat > /etc/systemd/system/pandora-agent.service <<'SVCEOF'
          [Unit]
          Description=Pandora Box Console Agent
          After=network.target postgresql.service redis.service
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/pandora-box/backend
          ExecStart=/opt/pandora-box/backend/pandora-agent --config /opt/pandora-box/configs/agent-config.yaml
          Restart=on-failure
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          
          [Install]
          WantedBy=multi-user.target
          SVCEOF
          
          # é‡æ–°è¼‰å…¥ä¸¦å•Ÿç”¨æœå‹™
          systemctl daemon-reload
          systemctl enable pandora-agent.service
          
          echo ""
          echo "======================================"
          echo "  å®‰è£å®Œæˆï¼"
          echo "======================================"
          echo ""
          echo "ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å•Ÿå‹•æœå‹™ï¼š"
          echo "  systemctl start pandora-agent"
          echo ""
          echo "æŸ¥çœ‹æœå‹™ç‹€æ…‹ï¼š"
          echo "  systemctl status pandora-agent"
          echo ""
          INSTALLEOF
          
          chmod +x $ISO_DIR/install.sh
          
          # å‰µå»º README
          cat > $ISO_DIR/README.txt <<EOF
          Pandora Box Console IDS-IPS v$VERSION
          ======================================
          
          å®‰è£èªªæ˜ï¼š
          
          1. å°‡å…‰ç¢Ÿæ›è¼‰åˆ°ç³»çµ±
          2. ä»¥ root æ¬Šé™åŸ·è¡Œ: ./install.sh
          3. å•Ÿå‹•æœå‹™: systemctl start pandora-agent
          
          è©³ç´°æ–‡æª”è«‹åƒè€ƒ: https://github.com/your-org/pandora_box_console_IDS-IPS
          
          æŠ€è¡“æ”¯æ´: support@pandora-ids.com
          EOF
          
          # è¤‡è£½ isolinux æª”æ¡ˆ
          cp /usr/lib/ISOLINUX/isolinux.bin $ISO_DIR/isolinux/
          cp /usr/lib/syslinux/modules/bios/ldlinux.c32 $ISO_DIR/isolinux/
          
          # å‰µå»º isolinux é…ç½®
          cat > $ISO_DIR/isolinux/isolinux.cfg <<EOF
          DEFAULT install
          PROMPT 0
          TIMEOUT 50
          
          LABEL install
            MENU LABEL Install Pandora Box Console
            KERNEL /install.sh
          EOF
      
      - name: æ§‹å»º ISO æ˜ åƒ
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p dist
          
          # å‰µå»ºç°¡çŸ­çš„ Volume IDï¼ˆé™åˆ¶ 32 å­—ç¬¦ï¼‰
          VOLUME_ID="PandoraBox-${VERSION}"
          if [[ ${#VOLUME_ID} -gt 32 ]]; then
            VOLUME_ID="PandoraBox-v${VERSION:0:20}"
          fi
          
          genisoimage \
            -o dist/pandora-box-console-${VERSION}-amd64.iso \
            -b isolinux/isolinux.bin \
            -c isolinux/boot.cat \
            -no-emul-boot \
            -boot-load-size 4 \
            -boot-info-table \
            -J -R -V "${VOLUME_ID}" \
            iso/
          
          # å‰µå»º MD5 æ ¡é©—å’Œ
          cd dist
          md5sum pandora-box-console-${VERSION}-amd64.iso > pandora-box-console-${VERSION}-amd64.iso.md5
          cd ..
      
      - name: ä¸Šå‚³ ISO æ˜ åƒ
        uses: actions/upload-artifact@v4
        with:
          name: iso-image
          path: |
            dist/*.iso
            dist/*.md5
          retention-days: 30

  # å‰µå»ºç™¼å¸ƒ
  create-release:
    name: å‰µå»º GitHub Release
    needs: [prepare, build-windows-installer, build-linux-packages, build-iso-image]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.ref == 'refs/heads/dev' && github.event_name == 'push')
    permissions:
      contents: write
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ä¸‹è¼‰æ‰€æœ‰æ§‹å»ºç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: æ•´ç†æ§‹å»ºç”¢ç‰©
        run: |
          # åˆ—å‡ºä¸‹è¼‰çš„æª”æ¡ˆçµæ§‹
          echo "Downloaded artifacts structure:"
          ls -R release-artifacts/
          
          # åªè¤‡è£½å¯¦éš›çš„æ§‹å»ºç”¢ç‰©ï¼ˆå®‰è£æª”ã€å¥—ä»¶ã€ISO ç­‰ï¼‰
          mkdir -p release-files
          
          # è¤‡è£½ Windows å®‰è£ç¨‹å¼ï¼ˆ.exe å®‰è£æª”ï¼‰
          find release-artifacts -path "*/dist/*.exe" -type f -exec cp {} release-files/ \; 2>/dev/null || true
          
          # è¤‡è£½ Linux å¥—ä»¶
          find release-artifacts -name "*.deb" -type f -exec cp {} release-files/ \; 2>/dev/null || true
          find release-artifacts -name "*.rpm" -type f -exec cp {} release-files/ \; 2>/dev/null || true
          
          # è¤‡è£½ ISO æ˜ åƒå’Œç›¸é—œæª”æ¡ˆ
          find release-artifacts -name "*.iso" -type f -exec cp {} release-files/ \; 2>/dev/null || true
          find release-artifacts -name "*.iso.md5" -type f -exec cp {} release-files/ \; 2>/dev/null || true
          
          # è¤‡è£½ Packer é…ç½®
          find release-artifacts -name "*.hcl" -type f -exec cp {} release-files/ \; 2>/dev/null || true
          
          # è¤‡è£½ OVA æª”æ¡ˆï¼ˆå¦‚æœæœ‰ï¼‰
          find release-artifacts -name "*.ova" -type f -exec cp {} release-files/ \; 2>/dev/null || true
          
          # ç‚º macOS äºŒé€²åˆ¶æª”æ¡ˆå‰µå»ºå£“ç¸®åŒ…
          echo ""
          echo "Creating macOS binary archives..."
          
          # macOS amd64
          if [ -d "release-artifacts/backend-macos-latest-amd64" ]; then
            cd release-artifacts/backend-macos-latest-amd64
            tar -czf ../../release-files/pandora-box-console-${{ needs.prepare.outputs.version }}-darwin-amd64.tar.gz *
            cd ../..
            echo "Created darwin-amd64 archive"
          fi
          
          # macOS arm64
          if [ -d "release-artifacts/backend-macos-latest-arm64" ]; then
            cd release-artifacts/backend-macos-latest-arm64
            tar -czf ../../release-files/pandora-box-console-${{ needs.prepare.outputs.version }}-darwin-arm64.tar.gz *
            cd ../..
            echo "Created darwin-arm64 archive"
          fi
          
          echo ""
          echo "Files to upload:"
          ls -lh release-files/
          echo ""
          echo "Total files: $(ls -1 release-files/ | wc -l)"
      
      - name: ç‚ºåˆ†æ”¯å‰µå»º tag
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG_NAME="v${{ needs.prepare.outputs.version }}"
          else
            TAG_NAME="dev-${{ needs.prepare.outputs.version }}"
          fi
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æª¢æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, deleting it first"
            git tag -d "$TAG_NAME"
            git push origin ":refs/tags/$TAG_NAME" || true
          fi
          
          git tag -a "$TAG_NAME" -m "Release ${{ needs.prepare.outputs.version }} from ${{ github.ref_name }}"
          git push origin "$TAG_NAME"
          
          # ç­‰å¾… tag åŒæ­¥
          echo "Waiting for tag to be available..."
          sleep 5
      
      - name: å‰µå»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref == 'refs/heads/main' && format('v{0}', needs.prepare.outputs.version) || (github.ref == 'refs/heads/dev' && format('dev-{0}', needs.prepare.outputs.version)) || github.ref_name }}
          name: Pandora Box Console v${{ needs.prepare.outputs.version }}${{ github.ref == 'refs/heads/dev' && '-dev' || '' }}
          body: |
            ## ğŸ‰ Pandora Box Console IDS-IPS v${{ needs.prepare.outputs.version }}${{ github.ref == 'refs/heads/dev' && ' (Development)' || '' }}
            
            ### ğŸ“¦ å®‰è£æª”æ¡ˆ
            
            #### Windows
            - `pandora-box-console-*-windows-amd64-setup.exe` - Windows å®‰è£ç¨‹å¼
            
            #### Linux
            - `pandora-box-console-*_amd64.deb` - Debian/Ubuntu å¥—ä»¶
            - `pandora-box-console-*.rpm` - RedHat/CentOS å¥—ä»¶
            
            #### macOS
            - `pandora-box-console-*-darwin-amd64.tar.gz` - macOS Intel (x86_64) äºŒé€²åˆ¶æª”æ¡ˆ
            - `pandora-box-console-*-darwin-arm64.tar.gz` - macOS Apple Silicon (ARM64) äºŒé€²åˆ¶æª”æ¡ˆ
            
            #### è™›æ“¬æ©Ÿ/å…‰ç¢Ÿ
            - `pandora-box-console-*-amd64.iso` - ISO å®‰è£å…‰ç¢Ÿ
            - `packer-config.pkr.hcl` - OVA è™›æ“¬æ©Ÿé…ç½®
            
            ### ğŸ“ æ›´æ–°æ—¥èªŒ
            
            è«‹åƒè€ƒ [CHANGELOG.md](CHANGELOG.md)
            
            ### ğŸ”§ ç³»çµ±éœ€æ±‚
            
            - **CPU**: 2 æ ¸å¿ƒä»¥ä¸Š
            - **è¨˜æ†¶é«”**: 4GB ä»¥ä¸Š
            - **å„²å­˜ç©ºé–“**: 20GB ä»¥ä¸Š
            - **ä½œæ¥­ç³»çµ±**: 
              - Windows 10/11 æˆ– Windows Server 2019/2022
              - Ubuntu 20.04/22.04 æˆ– Debian 11/12
              - RHEL/CentOS 8/9
            
            ### ğŸ“š æ–‡æª”
            
            - [å®‰è£æŒ‡å—](README.md#å¿«é€Ÿé–‹å§‹)
            - [è¨­å®šèªªæ˜](README.md#è¨­å®šèªªæ˜)
            - [æ•…éšœæ’é™¤](README.md#æ•…éšœæ’é™¤)
            
            ---
            
            **æ§‹å»ºè³‡è¨Š**
            - ç‰ˆæœ¬: ${{ needs.prepare.outputs.version }}
            - æ§‹å»ºæ—¥æœŸ: ${{ needs.prepare.outputs.build_date }}
            - Git Commit: ${{ needs.prepare.outputs.git_commit }}
          files: release-files/*
          draft: false
          prerelease: ${{ github.ref == 'refs/heads/dev' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

