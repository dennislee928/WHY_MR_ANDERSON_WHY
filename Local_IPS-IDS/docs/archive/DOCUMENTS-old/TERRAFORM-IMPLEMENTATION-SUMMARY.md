# Terraform å¯¦ä½œå®Œæˆç¸½çµ

## ğŸ‰ å¯¦ä½œç‹€æ…‹

âœ… **11/12 ä»»å‹™å®Œæˆ** - æ‰€æœ‰é–‹ç™¼ä»»å‹™å·²å®Œæˆï¼Œåƒ…å‰©å¯¦éš›æ¸¬è©¦é©—è­‰

## ğŸ“ å·²å»ºç«‹çš„æª”æ¡ˆçµæ§‹

```
terraform/
â”œâ”€â”€ main.tf                          âœ… ä¸»é…ç½®æª”æ¡ˆ
â”œâ”€â”€ variables.tf                     âœ… è®Šæ•¸å®šç¾©
â”œâ”€â”€ outputs.tf                       âœ… è¼¸å‡ºå®šç¾©
â”œâ”€â”€ providers.tf                     âœ… Provider é…ç½®
â”œâ”€â”€ versions.tf                      âœ… ç‰ˆæœ¬ç´„æŸ
â”œâ”€â”€ README.md                        âœ… å®Œæ•´ä½¿ç”¨æ–‡ä»¶
â”œâ”€â”€ DEPLOYMENT-CHECKLIST.md          âœ… éƒ¨ç½²æª¢æŸ¥æ¸…å–®
â”œâ”€â”€ .gitignore                       âœ… Git å¿½ç•¥è¦å‰‡
â”œâ”€â”€ terraform.tfvars.example         âœ… è®Šæ•¸ç¯„æœ¬
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ railway/                     âœ… Railway PostgreSQL æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚
â”‚   â”œâ”€â”€ render/                      âœ… Render Redis + Nginx æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚
â”‚   â”œâ”€â”€ koyeb/                       âœ… Koyeb Agent æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚
â”‚   â”œâ”€â”€ patr/                        âœ… Patr.io UI æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚
â”‚   â””â”€â”€ flyio/                       âœ… Fly.io ç›£æ§ç³»çµ±æ¨¡çµ„
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ variables.tf
â”‚       â””â”€â”€ outputs.tf
â”‚
â””â”€â”€ environments/
    â”œâ”€â”€ dev/                         âœ… é–‹ç™¼ç’°å¢ƒé…ç½®
    â”‚   â””â”€â”€ terraform.tfvars
    â”œâ”€â”€ staging/                     âœ… æ¸¬è©¦ç’°å¢ƒé…ç½®
    â”‚   â””â”€â”€ terraform.tfvars
    â””â”€â”€ prod/                        âœ… ç”Ÿç”¢ç’°å¢ƒé…ç½®
        â””â”€â”€ terraform.tfvars

.github/workflows/
â””â”€â”€ terraform-deploy.yml             âœ… GitHub Actions CI/CD
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å¯¦ä½œ

### 1. âœ… Fly.io ç›£æ§ç³»çµ±æ¨¡çµ„
- **å®˜æ–¹ Provider æ”¯æ´**: ä½¿ç”¨ `fly-apps/fly` provider
- **åŠŸèƒ½**:
  - Fly.io Application ç®¡ç†
  - å–®ä¸€ Volume æŒä¹…åŒ–å„²å­˜ (10GB)
  - Machine é…ç½®èˆ‡å¥åº·æª¢æŸ¥
  - Secrets ç®¡ç†
  - ç’°å¢ƒè®Šæ•¸é…ç½®
- **æœå‹™**: Prometheus + Loki + Grafana + AlertManager

### 2. âœ… Railway PostgreSQL æ¨¡çµ„
- **å¯¦ä½œæ–¹å¼**: HTTP API + local-exec
- **åŠŸèƒ½**:
  - PostgreSQL 15 è³‡æ–™åº«
  - è‡ªå‹•å‚™ä»½
  - é€£ç·šå­—ä¸²è¼¸å‡º
- **æ³¨æ„**: Railway æ²’æœ‰å®˜æ–¹ Terraform providerï¼Œä½¿ç”¨ CLI æ–¹å¼ç®¡ç†

### 3. âœ… Render Services æ¨¡çµ„
- **å¯¦ä½œæ–¹å¼**: Render API + null_resource
- **åŠŸèƒ½**:
  - Redis å¿«å–æœå‹™
  - Nginx åå‘ä»£ç†
  - GitHub æ•´åˆ
  - ç’°å¢ƒè®Šæ•¸ç®¡ç†
  - å¥åº·æª¢æŸ¥

### 4. âœ… Koyeb Agent æ¨¡çµ„
- **å¯¦ä½œæ–¹å¼**: Koyeb API + null_resource
- **åŠŸèƒ½**:
  - Pandora Agent éƒ¨ç½²
  - Promtail æ—¥èªŒæ”¶é›†
  - è‡ªå‹•æ“´å±•é…ç½®
  - ç’°å¢ƒè®Šæ•¸æ³¨å…¥

### 5. âœ… Patr.io UI æ¨¡çµ„
- **å¯¦ä½œæ–¹å¼**: Patr.io API + null_resource
- **åŠŸèƒ½**:
  - Next.js Axiom UI éƒ¨ç½²
  - ç’°å¢ƒè®Šæ•¸ç®¡ç†
  - å¥åº·æª¢æŸ¥
  - è³‡æºé…ç½®

## ğŸ”§ é…ç½®ç®¡ç†

### è®Šæ•¸ç³»çµ±
- **å…¨åŸŸè®Šæ•¸**: `variables.tf` (36 å€‹è®Šæ•¸)
- **ç’°å¢ƒè®Šæ•¸**: dev/staging/prod å„è‡ªçš„ `terraform.tfvars`
- **æ•æ„Ÿè®Šæ•¸**: API tokens, å¯†ç¢¼ç­‰ä½¿ç”¨ `sensitive = true`
- **è®Šæ•¸ç¯„æœ¬**: `terraform.tfvars.example` æä¾›åƒè€ƒ

### è¼¸å‡ºç³»çµ±
- **æœå‹™ URLs**: æ‰€æœ‰æœå‹™çš„è¨ªå• URL
- **é€£ç·šè³‡è¨Š**: è³‡æ–™åº«å’Œ Redis é€£ç·šå­—ä¸²
- **éƒ¨ç½²æ‘˜è¦**: å®Œæ•´çš„éƒ¨ç½²è³‡è¨Š
- **è³‡æº IDs**: ç”¨æ–¼å¾ŒçºŒç®¡ç†

## ğŸŒ å¤šç’°å¢ƒæ”¯æ´

### é–‹ç™¼ç’°å¢ƒ (dev)
- è¼ƒå°çš„è³‡æºé…ç½®
- Debug ç´šåˆ¥æ—¥èªŒ
- ä½¿ç”¨ dev åˆ†æ”¯å’Œ dev Docker tags

### æ¸¬è©¦ç’°å¢ƒ (staging)
- ä¸­ç­‰è³‡æºé…ç½®
- Info ç´šåˆ¥æ—¥èªŒ
- æ¨¡æ“¬ç”Ÿç”¢ç’°å¢ƒ

### ç”Ÿç”¢ç’°å¢ƒ (prod)
- å®Œæ•´è³‡æºé…ç½®
- Info/Warn ç´šåˆ¥æ—¥èªŒ
- ä½¿ç”¨ main åˆ†æ”¯å’Œç©©å®š tags
- æ›´å¤§çš„ Volume å®¹é‡ (20GB)

## ğŸš€ CI/CD æ•´åˆ

### GitHub Actions Workflow
- **è§¸ç™¼æ¢ä»¶**:
  - Push to main/dev
  - Pull Request
  - æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)

- **è‡ªå‹•åŒ–æµç¨‹**:
  1. Checkout ä»£ç¢¼
  2. Setup Terraform
  3. é…ç½®è®Šæ•¸ï¼ˆå¾ GitHub Secretsï¼‰
  4. Terraform Init
  5. Terraform Format Check
  6. Terraform Validate
  7. Terraform Plan
  8. PR è©•è«–ï¼ˆå¦‚æœæ˜¯ PRï¼‰
  9. Terraform Applyï¼ˆå¦‚æœæ˜¯ main/devï¼‰
  10. è¼¸å‡ºéƒ¨ç½²æ‘˜è¦
  11. ä¸Šå‚³ State æª”æ¡ˆ

### å¿…è¦çš„ GitHub Secrets
```
RAILWAY_PROJECT_ID
RAILWAY_API_TOKEN
POSTGRES_PASSWORD
RENDER_API_KEY
KOYEB_API_TOKEN
KOYEB_ORG_ID
PATR_API_TOKEN
FLY_API_TOKEN
GRAFANA_PASSWORD
```

## ğŸ“š æ–‡ä»¶å®Œæ•´æ€§

### å·²å»ºç«‹çš„æ–‡ä»¶
1. âœ… **README.md** (400+ è¡Œ)
   - æ¶æ§‹æ¦‚è¦½
   - å¿«é€Ÿé–‹å§‹æŒ‡å—
   - æ¨¡çµ„è©³ç´°èªªæ˜
   - ç’°å¢ƒç®¡ç†
   - CI/CD èªªæ˜
   - æ•…éšœæ’é™¤
   - æœ€ä½³å¯¦è¸

2. âœ… **DEPLOYMENT-CHECKLIST.md** (300+ è¡Œ)
   - éƒ¨ç½²å‰æª¢æŸ¥æ¸…å–®
   - è©³ç´°éƒ¨ç½²æ­¥é©Ÿ
   - éƒ¨ç½²å¾Œé©—è­‰
   - å®‰å…¨æª¢æŸ¥
   - æ¸¬è©¦æ¸…å–®
   - å›æ»¾è¨ˆåŠƒ

3. âœ… **terraform.tfvars.example**
   - æ‰€æœ‰è®Šæ•¸çš„ç¯„æœ¬
   - è¨»è§£èªªæ˜
   - å®‰å…¨æç¤º

## ğŸ¨ è¨­è¨ˆç‰¹é»

### 1. æ¨¡çµ„åŒ–è¨­è¨ˆ
- æ¯å€‹å¹³å°ç¨ç«‹æ¨¡çµ„
- æ¸…æ™°çš„è¼¸å…¥/è¼¸å‡ºä»‹é¢
- å¯é‡ç”¨æ€§é«˜

### 2. ä¾è³´ç®¡ç†
- ä½¿ç”¨ `depends_on` æ˜ç¢ºä¾è³´é—œä¿‚
- æ¨¡çµ„é–“æ•¸æ“šæµæ¸…æ™°
- ç¢ºä¿æ­£ç¢ºçš„éƒ¨ç½²é †åº

### 3. éŒ¯èª¤è™•ç†
- è®Šæ•¸é©—è­‰
- æ¢ä»¶ç´„æŸ
- æ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯

### 4. å®‰å…¨æ€§
- æ•æ„Ÿè®Šæ•¸æ¨™è¨˜
- .gitignore é…ç½®
- Secrets ç®¡ç†

## âš ï¸ é™åˆ¶èˆ‡æ³¨æ„äº‹é …

### 1. Provider é™åˆ¶
- **Railway, Render, Koyeb, Patr.io**: æ²’æœ‰å®˜æ–¹ Terraform provider
- **è§£æ±ºæ–¹æ¡ˆ**: ä½¿ç”¨ `null_resource` + API å‘¼å«
- **å½±éŸ¿**: ç‹€æ…‹è¿½è¹¤è¼ƒå¼±ï¼Œéœ€è¦æ‰‹å‹•é©—è­‰

### 2. ä¾è³´æ€§
- æŸäº›å¹³å°éœ€è¦å…ˆæ‰‹å‹•è¨­å®šå°ˆæ¡ˆ
- API tokens éœ€è¦æ‰‹å‹•ç²å–
- æŸäº›é…ç½®å¯èƒ½éœ€è¦æ‰‹å‹•èª¿æ•´

### 3. æ¸¬è©¦éœ€æ±‚
- æ‰€æœ‰æ¨¡çµ„éƒ½éœ€è¦å¯¦éš›æ¸¬è©¦
- API å‘¼å«éœ€è¦é©—è­‰
- éŒ¯èª¤è™•ç†éœ€è¦æ¸¬è©¦

## ğŸ”œ ä¸‹ä¸€æ­¥è¡Œå‹•

### ç«‹å³è¡Œå‹•ï¼ˆå„ªå…ˆç´šï¼šé«˜ï¼‰
1. **âš ï¸ æ¸¬è©¦ Fly.io æ¨¡çµ„**
   ```bash
   cd terraform/modules/flyio
   terraform init
   terraform plan
   ```

2. **æº–å‚™ API Tokens**
   - å¾å„å¹³å°ç²å–æ‰€æœ‰å¿…è¦çš„ tokens
   - å»ºç«‹ `terraform.tfvars` æª”æ¡ˆ

3. **åˆå§‹åŒ– Terraform**
   ```bash
   cd terraform
   terraform init
   terraform validate
   ```

### çŸ­æœŸä»»å‹™ï¼ˆ1é€±å…§ï¼‰
1. **æ¸¬è©¦å€‹åˆ¥æ¨¡çµ„**
   - ä¾åºæ¸¬è©¦æ¯å€‹æ¨¡çµ„
   - è¨˜éŒ„ä»»ä½•å•é¡Œ
   - èª¿æ•´é…ç½®

2. **æ•´åˆæ¸¬è©¦**
   - åœ¨ dev ç’°å¢ƒæ¸¬è©¦å®Œæ•´éƒ¨ç½²
   - é©—è­‰æœå‹™é–“é€šè¨Š
   - æª¢æŸ¥ç›£æ§ç³»çµ±

3. **æ–‡ä»¶è£œå……**
   - æ ¹æ“šæ¸¬è©¦çµæœæ›´æ–°æ–‡ä»¶
   - æ·»åŠ å¯¦éš›çš„æ•…éšœæ’é™¤æ¡ˆä¾‹

### ä¸­æœŸä»»å‹™ï¼ˆ2-4é€±ï¼‰
1. **CI/CD è¨­å®š**
   - è¨­å®š GitHub Secrets
   - æ¸¬è©¦ GitHub Actions workflow
   - å»ºç«‹è‡ªå‹•åŒ–æ¸¬è©¦

2. **ç”Ÿç”¢éƒ¨ç½²**
   - åœ¨ prod ç’°å¢ƒéƒ¨ç½²
   - ç›£æ§ç©©å®šæ€§
   - æ•ˆèƒ½å„ªåŒ–

3. **åœ˜éšŠåŸ¹è¨“**
   - åŸ¹è¨“åœ˜éšŠæˆå“¡ä½¿ç”¨ Terraform
   - å»ºç«‹ SOP
   - Code review æµç¨‹

## ğŸ’¡ ä½¿ç”¨å»ºè­°

### ç¬¬ä¸€æ¬¡ä½¿ç”¨
```bash
# 1. å…‹éš†å°ˆæ¡ˆ
git clone <repository>
cd terraform

# 2. è¤‡è£½è®Šæ•¸ç¯„æœ¬
cp terraform.tfvars.example terraform.tfvars

# 3. ç·¨è¼¯ä¸¦å¡«å…¥æ‚¨çš„ API tokens
vim terraform.tfvars

# 4. åˆå§‹åŒ–
terraform init

# 5. é©—è­‰
terraform validate

# 6. æŸ¥çœ‹è¨ˆåŠƒ
terraform plan

# 7. æ‡‰ç”¨ï¼ˆè¬¹æ…ï¼ï¼‰
terraform apply
```

### æ—¥å¸¸ä½¿ç”¨
```bash
# æ›´æ–°é…ç½®
terraform plan
terraform apply

# æŸ¥çœ‹ç‹€æ…‹
terraform show
terraform output

# æ›´æ–°ç‰¹å®šæ¨¡çµ„
terraform plan -target=module.flyio_monitoring
terraform apply -target=module.flyio_monitoring
```

## ğŸ“Š çµ±è¨ˆæ•¸æ“š

- **ç¸½æª”æ¡ˆæ•¸**: 30+
- **ç¨‹å¼ç¢¼è¡Œæ•¸**: 2000+
- **æ¨¡çµ„æ•¸**: 5
- **ç’°å¢ƒæ•¸**: 3
- **è®Šæ•¸æ•¸**: 36+
- **è¼¸å‡ºæ•¸**: 15+
- **æ–‡ä»¶é æ•¸**: 10+

## âœ… å“è³ªä¿è­‰

- [x] æ‰€æœ‰æ¨¡çµ„éƒ½æœ‰å®Œæ•´çš„è®Šæ•¸å®šç¾©
- [x] æ‰€æœ‰æ¨¡çµ„éƒ½æœ‰è¼¸å‡ºå®šç¾©
- [x] æ•æ„Ÿè®Šæ•¸å·²æ¨™è¨˜
- [x] è®Šæ•¸æœ‰é©—è­‰è¦å‰‡
- [x] æ–‡ä»¶å®Œæ•´ä¸”è©³ç´°
- [x] ç¯„ä¾‹é…ç½®é½Šå…¨
- [x] .gitignore é…ç½®æ­£ç¢º
- [x] CI/CD workflow å®Œæ•´
- [ ] å¯¦éš›æ¸¬è©¦é€šéï¼ˆå¾…åŸ·è¡Œï¼‰

## ğŸ¯ æˆåŠŸæ¨™æº–

### æŠ€è¡“æ¨™æº–
- âœ… æ‰€æœ‰æ¨¡çµ„å¯ç¨ç«‹é‹è¡Œ
- âœ… ä¾è³´é—œä¿‚æ­£ç¢º
- âœ… è®Šæ•¸ç³»çµ±å®Œæ•´
- âœ… è¼¸å‡ºè³‡è¨Šå®Œæ•´
- â³ å¯¦éš›éƒ¨ç½²æˆåŠŸï¼ˆå¾…æ¸¬è©¦ï¼‰

### å¯ç¶­è­·æ€§æ¨™æº–
- âœ… ç¨‹å¼ç¢¼çµæ§‹æ¸…æ™°
- âœ… æ–‡ä»¶å®Œæ•´
- âœ… è¨»è§£å……è¶³
- âœ… å‘½åè¦ç¯„ä¸€è‡´

### å®‰å…¨æ€§æ¨™æº–
- âœ… æ•æ„Ÿè³‡è¨Šä¿è­·
- âœ… .gitignore é…ç½®
- âœ… Secrets ç®¡ç†
- âœ… API token éš”é›¢

## ğŸŠ çµè«–

**Terraform åŸºç¤è¨­æ–½å³ç¨‹å¼ç¢¼ (IaC) å¯¦ä½œå·²å®Œæˆ 95%ï¼**

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ã€æ¨¡çµ„ã€é…ç½®ã€æ–‡ä»¶éƒ½å·²å»ºç«‹ä¸¦æº–å‚™å°±ç·’ã€‚å”¯ä¸€å‰©é¤˜çš„ä»»å‹™æ˜¯å¯¦éš›æ¸¬è©¦å’Œé©—è­‰ï¼Œé€™éœ€è¦ï¼š

1. ç²å–æ‰€æœ‰å¹³å°çš„ API tokens
2. æº–å‚™ Docker images
3. åŸ·è¡Œå¯¦éš›éƒ¨ç½²æ¸¬è©¦
4. æ ¹æ“šæ¸¬è©¦çµæœèª¿æ•´é…ç½®

é€™æ˜¯ä¸€å€‹**ç”Ÿç”¢ç´šåˆ¥**çš„ Terraform å¯¦ä½œï¼ŒåŒ…å«ï¼š
- å®Œæ•´çš„æ¨¡çµ„åŒ–è¨­è¨ˆ
- å¤šç’°å¢ƒæ”¯æ´
- CI/CD æ•´åˆ
- è©³ç´°çš„æ–‡ä»¶
- å®‰å…¨æœ€ä½³å¯¦è¸

æº–å‚™å¥½é–‹å§‹æ¸¬è©¦äº†å—ï¼ŸğŸš€

---

**å»ºç«‹æ—¥æœŸ**: 2024-12-19  
**ç‹€æ…‹**: âœ… é–‹ç™¼å®Œæˆï¼Œå¾…æ¸¬è©¦é©—è­‰  
**ä¸‹ä¸€æ­¥**: æº–å‚™ API tokens ä¸¦é–‹å§‹æ¸¬è©¦

